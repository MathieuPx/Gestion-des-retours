<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace Client AAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
  // Donn√©es fictives pour les graphiques camembert
  document.addEventListener("DOMContentLoaded", function () {
    const chartStatut = document.getElementById('chart-statut');
    if (chartStatut) {
      new Chart(chartStatut, {
        type: 'pie',
        data: {
          labels: ['En attente', 'Pris en charge', 'Valid√©', 'Refus√©'],
          datasets: [{
            data: [5, 3, 8, 2],
            backgroundColor: ['#f4c542', '#4e73df', '#1cc88a', '#e74a3b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    const chartType = document.getElementById('chart-type');
    if (chartType) {
      new Chart(chartType, {
        type: 'pie',
        data: {
          labels: ['Retour', 'Consigne', 'Garantie', 'Autre'],
          datasets: [{
            data: [6, 4, 2, 1],
            backgroundColor: ['#36b9cc', '#f6c23e', '#858796', '#20c997']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }
  });
function filterTable(colIndex) {
  const inputBoxes = document.querySelectorAll('thead input');
  const table = document.querySelector('#table-retours');
  const filter = inputBoxes[colIndex].value.toUpperCase();
  const rows = table.getElementsByTagName('tr');

  for (let i = 0; i < rows.length; i++) {
    const cell = rows[i].getElementsByTagName('td')[colIndex];
    if (cell) {
      const textValue = cell.textContent || cell.innerText;
      rows[i].style.display = textValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
    }
  }
}
function toggleFilter(col) {
  const inputs = document.querySelectorAll('thead input');
  const target = inputs[col];
  if (target) {
    const visible = target.style.display === 'inline-block';
    inputs.forEach(input => input.style.display = 'none');
    target.style.display = visible ? 'none' : 'inline-block';
    if (!visible) target.focus();
  }
}
function exportSelectedRowsToCSV() {
  const rows = document.querySelectorAll('#table-retours tr');
  let csvContent = '';
  rows.forEach(row => {
    const checkbox = row.querySelector('input[type="checkbox"]');
    if (checkbox && checkbox.checked) {
      const cols = row.querySelectorAll('td');
      const rowData = [];
      for (let i = 1; i < cols.length - 1; i++) {
        rowData.push('"' + cols[i].innerText.trim().replace(/
/g, ' ') + '"');
      }
      csvContent += rowData.join(',') + '
';
    }
  });
  if (!csvContent) return alert('Veuillez s√©lectionner au moins une ligne.');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.setAttribute('href', URL.createObjectURL(blob));
  link.setAttribute('download', 'retours_selection.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.getElementById('select-all')?.addEventListener('change', function () {
  document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = this.checked);
});
function handleRetourSubmit(event) {
  event.preventDefault();
  const tableBody = document.querySelector('#table-retours tbody');
  const now = new Date().toLocaleString('fr-FR');
  const form = document.querySelector('#form-retour');
  const lignes = form.querySelectorAll('tbody tr');

  lignes.forEach((row, i) => {
    const ref = row.querySelector('[name="ref[]"]').value || '-';
    const des = row.querySelector('[name="des[]"]').value || '-';
    const qte = row.querySelector('[name="qte[]"]').value || '1';
    const type = row.querySelector('[name="type[]"]').value || '-';
    const precision = row.querySelector('[name="precision[]"]').value || '-';
    const numero = 'CLIENT-' + Date.now().toString().slice(-6) + '-' + i;

    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>${now}</td>
      <td>${ref}</td>
      <td>${des}</td>
      <td>${type.toUpperCase()}</td>
      <td>${qte}</td>
      <td>${precision}</td>
      <td>${numero}</td>
      <td>EN ATTENTE</td>
      <td><button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    `;
    tableBody.prepend(newRow);
  });

  form.reset();
  alert('Retour envoy√© avec succ√®s !');
  showSection('#accueil');
  // TODO : ajouter ici le code pour ins√©rer la ligne dans la table HTML c√¥t√© historique si besoin
}
</script>
  <style>
    :root {
      --bleu-fonce: #0b1e49;
      --bleu-clair: #4e73df;
      --jaune-aai: #ffe04c;
      --blanc: #ffffff;
      --gris-clair: #f4f4f4;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--gris-clair);
    }

    header.topbar {
      background: var(--bleu-fonce);
      color: var(--blanc);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    header.topbar h1 {
      font-size: 1.8rem;
    }

    nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      width: 100%;
    }

    nav a {
      color: var(--bleu-fonce);
      background-color: var(--jaune-aai);
      padding: 0.4rem 1rem;
      border-radius: 6px;
      font-weight: bold;
      text-decoration: none;
      transition: background-color 0.3s ease;
      text-align: center;
      flex: 1;
      max-width: 160px;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    nav a.active {
      background-color: var(--bleu-clair);
      color: white;
    }

    nav a:hover {
      background-color: #ffd633;
    }

    .profile-icon {
      font-size: 1.8rem;
      color: var(--jaune-aai);
    }

    main {
      padding: 2rem;
    }

    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--blanc);
      border-left: 6px solid var(--jaune-aai);
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }

    .button-jaune {
      background: var(--jaune-aai);
      color: var(--bleu-fonce);
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .button-bleu {
      background: var(--bleu-fonce);
      color: var(--jaune-aai);
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .chart-box {
      background: var(--blanc);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.05);
    }

    .table-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .table-actions h3 {
      margin: 0;
    }

    .table-actions select,
    .table-actions input[type="text"],
    .table-actions button {
      margin-left: 1rem;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--blanc);
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
      border-radius: 10px;
      overflow: hidden;
    }

    table th, table td {
  padding: 0.6rem 0.4rem;
  border-bottom: 1px solid #eee;
  text-align: left;
  white-space: nowrap;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
}

    table thead {
  background: var(--jaune-aai);
  color: var(--bleu-fonce);
  font-size: 0.85rem;
  font-weight: 600;
  text-align: left;
  border-bottom: 2px solid var(--bleu-fonce);
  white-space: nowrap;
}

    footer {
      background: var(--jaune-aai);
      text-align: center;
      font-size: 0.85rem;
      color: var(--bleu-fonce);
      padding: 1rem;
    }
  </style>
</head>
<body>
  <header class="topbar" style="position: relative; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
    <h1 style="margin: 0 1rem;">Espace Client</h1>
    <nav style="display: flex; justify-content: center; align-items: center; width: 100%; gap: 0.5rem; flex-wrap: wrap;">
      <a href="#accueil">Accueil</a>
      <a href="#retours">Historique</a>
      <a href="#formulaire">Cr√©er un retour</a>
      <a href="#stats">Tableau de bord</a>
      <a href="#mon-compte">Mon compte</a>
    </nav>
    <div style="position: absolute; top: 1rem; right: 1rem;">
      <a href="#" onclick="logout()" style="background-color: #e63946; color: white; padding: 0.4rem 1rem; border-radius: 6px; font-weight: bold; text-decoration: none;">D√©connexion</a>
    </div>
  </header>

  <main id="accueil" style="display: block;">
    <section class="dashboard-cards">
      <div class="card">
        <h2>üïì En attente</h2>
        <p><strong id="stat-en-attente">0</strong> retour(s)</p>
      </div>
      <div class="card">
        <h2>‚öôÔ∏è Pris en charge</h2>
        <p><strong id="stat-en-cours">0</strong> retour(s)</p>
      </div>
      <div class="card">
        <h2>‚úÖ Valid√©</h2>
        <p><strong id="stat-termines">0</strong> retour(s)</p>
      </div>
      <div class="card">
        <h2>‚ùå Refus√©</h2>
        <p><strong id="stat-refuses">0</strong> retour(s)</p>
      </div>
    </section>
    </main>
  
<main id="formulaire" style="display: none;">
  <h2>Cr√©er un retour</h2>
  <form id="form-retour" onsubmit="handleRetourSubmit(event)">
    <table id="form-lignes-retour">
      <thead>
        <tr>
          <th>R√©f√©rence</th>
          <th>D√©signation</th>
          <th>Quantit√©</th>
          <th>Type de retour</th>
          <th>Pr√©cision</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" name="ref[]" style="width: 80px;" required></td>
          <td><input type="text" name="des[]" style="width: 140px;"></td>
          <td><input type="number" name="qte[]" min="1" style="width: 60px;" required></td>
          <td>
            <select name="type[]" onchange="toggleNoticeGarantie(this)" style="width: 100px;">
              <option value="Pi√®ce">Pi√®ce</option>
              <option value="Consigne">Consigne</option>
              <option value="Garantie">Garantie</option>
              <option value="Autre">Autre</option>
            </select>
          </td>
          <td><input type="text" name="precision[]" style="width: 140px;"></td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="button-jaune" onclick="ajouterLigneRetour()">‚ûï Ajouter une autre ligne</button>
    <div id="notice-garantie" class="hidden" style="background: #fffbe6; padding: 1rem; border-left: 4px solid #ffe04c; margin-top: 1rem; display: none;">
      <strong>üì¶ Pour un retour en garantie :</strong><br>
      Merci de fournir : bon de livraison, facture client et de garantie, photocopie de la carte grise et photo du montage si n√©cessaire.
    </div>
    <div style="margin-top: 1rem;">
      <button type="submit" class="button-bleu">üì§ Envoyer le retour</button>
    </div>
  </form>
</main>

<script>
function ajouterLigneRetour() {
  const tbody = document.querySelector('#form-lignes-retour tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" name="ref[]" required></td>
    <td><input type="text" name="des[]"></td>
    <td><input type="number" name="qte[]" min="1" required></td>
    <td>
      <select name="type[]" onchange="toggleNoticeGarantie(this)">
        <option value="Pi√®ce">Pi√®ce</option>
        <option value="Consigne">Consigne</option>
        <option value="Garantie">Garantie</option>
        <option value="Autre">Autre</option>
      </select>
    </td>
    <td><input type="text" name="precision[]"></td>`;
  tbody.appendChild(row);
}

function toggleNoticeGarantie(select) {
  const notice = document.getElementById('notice-garantie');
  const lignes = document.querySelectorAll('select[name="type[]"]');
  const show = Array.from(lignes).some(s => s.value === 'Garantie');
  notice.style.display = show ? 'block' : 'none';
}
</script>

  <main id="stats" style="display: none;">
    <section class="chart-container">
      <div class="chart-box">
        <h3>R√©partition des statuts</h3>
        <canvas id="chart-statut"></canvas>
      </div>
      <div class="chart-box">
        <h3>R√©partition par type de retour</h3>
        <canvas id="chart-type"></canvas>
      </div>
    </section>
  </main>

  <main id="retours" style="display: none;">
  <h2>Historique de mes retours</h2>
  <div class="table-actions">
    <label for="search-bar">üîç Rechercher :</label>
    <input type="text" id="search-bar" placeholder="Filtrer...">
    <button class="button-jaune" onclick="exportSelectedRowsToCSV()">üì§ Exporter la s√©lection</button>
  </div>
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="select-all"></th>
        <th>Date <button-bleu onclick="toggleFilter(0)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Date" onkeyup="filterTable(0)" style="display:none;"></th>
        <th>R√©f√©rence <button-bleu onclick="toggleFilter(1)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="R√©f√©rence" onkeyup="filterTable(1)" style="display:none;"></th>
        <th>D√©signation <button-bleu onclick="toggleFilter(2)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="D√©signation" onkeyup="filterTable(2)" style="display:none;"></th>
        <th>Type <button-bleu onclick="toggleFilter(3)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Type de retour" onkeyup="filterTable(3)" style="display:none;"></th>
        <th>Qt√© <button-bleu onclick="toggleFilter(4)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Quantit√©" onkeyup="filterTable(4)" style="display:none;"></th>
        <th>Pr√©cision <button-bleu onclick="toggleFilter(5)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Pr√©cision" onkeyup="filterTable(5)" style="display:none;"></th>
        <th>N¬∞ Retour <button-bleu onclick="toggleFilter(6)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Num√©ro" onkeyup="filterTable(6)" style="display:none;"></th>
        <th>Statut <button-bleu onclick="toggleFilter(7)">üîç</button-bleu><br><input class="filter-input" type="text" placeholder="Statut" onkeyup="filterTable(7)" style="display:none;"></th>
        <th>PDF</th>
      </tr>
    </thead>
    <tr>
        <td><input type="checkbox" class="row-checkbox"></td>
      <td>29/03/2025 17:19:29</td>
      <td>L1044</td>
      <td>nan</td>
      <td>PI√àCE</td>
      <td>1</td>
      <td>PAS MONT√â</td>
      <td>24868-2025-03-0020</td>
      <td>PRIS EN CHARGE</td>
      <td> <button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>29/03/2025 17:46:39</td>
      <td>AH245-2</td>
      <td>nan</td>
      <td>PI√àCE</td>
      <td>1</td>
      <td>PAS EU BESOIN</td>
      <td>24868-2025-03-0021</td>
      <td>VALID√â</td>
      <td> <button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>30/03/2025 11:05:03</td>
      <td>L343D</td>
      <td>nan</td>
      <td>PI√àCE</td>
      <td>1</td>
      <td>PAS MONT√â</td>
      <td>24868-2025-03-0022</td>
      <td><span title="PAS OUVERT PROPREMENT">REFUS√â</span></td>
      <td><button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>30/03/2025 11:06:52</td>
      <td>AH245-2</td>
      <td>nan</td>
      <td>PI√àCE</td>
      <td>1</td>
      <td>PAS MONT√â</td>
      <td>24868-2025-03-0023</td>
      <td>EN ATTENTE</td>
      <td> <button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    </tr>

    <tr>
      <td><input type="checkbox" class="row-checkbox"></td>
      <td>30/03/2025 16:00:24</td>
      <td>L343D</td>
      <td>nan</td>
      <td>PI√àCE</td>
      <td>1</td>
      <td>PAS MONT√â</td>
      <td>24868-2025-03-0024</td>
      <td>EN ATTENTE</td>
      <td> <button class="button-bleu" onclick="window.print()">üìÑ PDF</button></td>
    </tr>
    </tbody>
  </table>
</main>

<script>
  const links = document.querySelectorAll('nav a');
  const sections = document.querySelectorAll('main');

  function showSection(id) {
    console.log('Tentative d\'affichage de la section :', id);
    sections.forEach(section => {
      console.log('Masquage de la section :', section.id);
      section.style.display = 'none';
    });
    const target = document.querySelector(id);
    if (target) {
      target.style.display = 'block';
      console.log('Section affich√©e :', id);
    } else {
      console.warn('Section introuvable :', id);
    }
  }

  links.forEach(link => {
    link.addEventListener('click', e => {
      const target = link.getAttribute('href');
      console.log('Lien cliqu√© :', target);
      if (target.startsWith('#')) {
        e.preventDefault();
        showSection(target);
        links.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
      }
    });
  });

  window.addEventListener('DOMContentLoaded', () => {
    console.log('Chargement termin√©, affichage de #accueil');
    showSection('#accueil');
  });
</script>
</body>
</html>
