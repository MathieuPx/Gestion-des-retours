<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace Client AAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <h1>AAI</h1>
    <nav>
      <a href="#">Accueil</a>
      <a href="#">Tableau de bord</a>
      <a href="#">Créer un retour</a>
      <a href="#">Historique</a>
      <a href="#">Statistiques</a>
      <a href="#">Support</a>
    </nav>
    <div class="profile-icon" title="Mon profil"><i class="fas fa-user-circle"></i></div>
  </header>

  <main>
    <section class="dashboard-cards">
      <div class="card">
        <h3>Retours en attente</h3>
        <p><strong id="stat-attente">0</strong></p>
      </div>
      <div class="card">
        <h3>Retours en cours</h3>
        <p><strong id="stat-encours">0</strong></p>
      </div>
      <div class="card">
        <h3>Retours terminés</h3>
        <p><strong id="stat-termes">0</strong></p>
      </div>
      <div class="card">
        <button class="button-jaune" onclick="location.href='formulaireRetour.html'" aria-label="Créer un retour"><i class="fas fa-plus"></i> Créer un retour</button>
      </div>
    </section>

    <section class="chart-container">
      <div class="chart-box">
        <h3>Évolution mensuelle</h3>
        <canvas id="chart1"></canvas>
      </div>
      <div class="chart-box">
        <h3>Répartition par motif</h3>
        <canvas id="chart2"></canvas>
      </div>
    </section>

    <section>
      <div class="table-actions">
        <h3>Historique des retours</h3>
        <div>
          <select id="filtre-statut">
            <option value="">Tous les statuts</option>
            <option value="En attente">En attente</option>
            <option value="En cours">En cours</option>
            <option value="Terminé">Terminé</option>
          </select>
          <input type="text" id="search-bar" placeholder="Rechercher..." aria-label="Recherche">
          <button onclick="exportCSV()" aria-label="Exporter les données">Exporter</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Référence</th>
            <th>Désignation</th>
            <th>Pré-accord</th>
            <th>Statut</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr><td colspan="6">Chargement...</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <footer>
    &copy; 2025 <strong>AAI</strong>. Tous droits réservés.
  </footer>

  <script>
    function applyFilters() {
      const statut = document.getElementById("filtre-statut").value.toLowerCase();
      const search = document.getElementById("search-bar").value.toLowerCase();
      const rows = document.querySelectorAll("#table-body tr");

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const cellText = Array.from(cells).map(c => c.textContent.toLowerCase()).join(" ");
        const show = (!statut || cellText.includes(statut)) && (!search || cellText.includes(search));
        row.style.display = show ? "" : "none";
      });
    }

    if (typeof google !== 'undefined' && google.script && google.script.run) {
      window.addEventListener("DOMContentLoaded", () => {
        google.script.run.withSuccessHandler(function(html) {
          document.getElementById("table-body").innerHTML = html;
          Array.from(document.querySelectorAll('.btn-pdf')).forEach(btn => {
            btn.addEventListener('click', function () {
              const ref = this.getAttribute('data-ref');
              google.script.run.exportPDF(ref);
            });
          });
        }).getHistoriqueRetours();

        google.script.run.withSuccessHandler(function(stats) {
          document.getElementById("stat-attente").textContent = stats.attente;
          document.getElementById("stat-encours").textContent = stats.encours;
          document.getElementById("stat-termes").textContent = stats.termines;
        }).getStatsRetours();

        google.script.run.withSuccessHandler(function(data) {
          new Chart(document.getElementById('chart1'), {
            type: 'line',
            data: {
              labels: data.labels,
              datasets: [{
                label: 'Retours',
                data: data.values,
                borderColor: '#0b1e49',
                backgroundColor: 'rgba(11,30,73,0.1)'
              }]
            }
          });
        }).getGraphData();

        google.script.run.withSuccessHandler(function(donnees) {
          new Chart(document.getElementById('chart2'), {
            type: 'doughnut',
            data: {
              labels: donnees.labels,
              datasets: [{
                data: donnees.valeurs,
                backgroundColor: donnees.couleurs
              }]
            },
            options: {
              plugins: {
                legend: {
                  position: 'right'
                }
              }
            }
          });
        }).getMotifsDonut();

        document.getElementById("filtre-statut").addEventListener("change", applyFilters);
        document.getElementById("search-bar").addEventListener("input", applyFilters);
      });
    } else {
      console.error("Ce script doit être exécuté dans un environnement Google Apps Script (HtmlService).");
    }

    function exportCSV() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        google.script.run.withSuccessHandler(function(url) {
          window.open(url, '_blank');
        }).exportCSV();
      } else {
        alert("Export CSV non disponible.");
      }
    }
  </script>
</body>
</html>


